<!doctype html>
<html lang="ru" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –ö–≤–µ—Å—Ç: –ü–µ—á–æ—Ä–∏–Ω</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <style>
    body { box-sizing: border-box; }
    .font-display { font-family: 'Playfair Display', serif; }
    .font-body { font-family: 'Montserrat', sans-serif; }
    
    @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-10px) rotate(2deg); } }
    @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(234, 179, 8, 0.3); } 50% { box-shadow: 0 0 40px rgba(234, 179, 8, 0.6); } }
    @keyframes glitch { 0% { transform: translate(0); filter: hue-rotate(0deg); } 20% { transform: translate(-2px, 2px); filter: hue-rotate(90deg); } 40% { transform: translate(2px, -2px); filter: hue-rotate(180deg); } 60% { transform: translate(-2px, -2px); filter: hue-rotate(270deg); } 80% { transform: translate(2px, 2px); filter: hue-rotate(360deg); } 100% { transform: translate(0); filter: hue-rotate(0deg); } }
    @keyframes sparkle { 0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); } 50% { opacity: 1; transform: scale(1) rotate(180deg); } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    
    .animate-float { animation: float 3s ease-in-out infinite; }
    .animate-glow { animation: glow 2s ease-in-out infinite; }
    .animate-glitch { animation: glitch 0.5s ease-in-out; }
    .animate-slide-in { animation: slideIn 0.5s ease-out forwards; }
    
    .word-chip { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
    .word-chip:hover { transform: scale(1.05); }
    .word-chip.selected { transform: scale(0.95); }
    
    .mountain-bg { background: linear-gradient(180deg, #1a1a2e 0%, #16213e 30%, #0f3460 60%, #533483 100%); }
    .duel-bg { background: linear-gradient(180deg, #2d1b0e 0%, #5c3d2e 30%, #8b6914 60%, #d4a574 100%); }
    .city-bg { background: linear-gradient(180deg, #1a0a2e 0%, #2d1b69 30%, #5b2c6f 60%, #f39c12 100%); }
    .progress-bar { background: linear-gradient(90deg, #eab308, #f59e0b); }
  </style>
</head>
<body class="h-full font-body text-white bg-[#1a1a2e]">
  <div id="app" class="h-full w-full overflow-auto"></div>

  <script>
    // --- –¢–í–û–ò –ù–ê–°–¢–†–û–ô–ö–ò FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAG5DU2VJR_8FjBUs6ZkhJ90FGmB05RP_Q",
      authDomain: "pechorin-quest.firebaseapp.com",
      databaseURL: "https://pechorin-quest-default-rtdb.firebaseio.com",
      projectId: "pechorin-quest",
      storageBucket: "pechorin-quest.firebasestorage.app",
      messagingSenderId: "234397373581",
      appId: "1:234397373581:web:f1b9b72f55939ad85d7ec4",
      measurementId: "G-TR56QES3EP"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò–ì–†–´ ---
    let currentUser = null;
    let completedEpisodes = [];
    let leaderBoardData = [];
    let currentEpisode = 0;
    
    const config = {
      game_title: '–û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –ö–≤–µ—Å—Ç',
      primary_action_color: '#eab308',
      secondary_action_color: '#8b5cf6',
      surface_color: '#2d2d44',
      text_color: '#f5f5f5',
      background_color: '#1a1a2e'
    };

    const episodes = [
      { id: 1, title: '–¢—Ä—ç—à –Ω–∞ –ö–∞–≤–∫–∞–∑–µ', location: '–ì–æ—Ä–Ω–æ–µ —É—â–µ–ª—å–µ', bgClass: 'mountain-bg', icon: 'üèîÔ∏è', originalText: '–ù—É –∏ –¥–≤–∏–∂ —Ç—É—Ç, –ø—Ä–æ—Å—Ç–æ —Ç—Ä—ç—à. –≠—Ç–∏ –≥–æ—Ä—Ü—ã ‚Äî –≤–æ–æ–±—â–µ —Ç–æ–ø—á–∏–∫!', correctText: '–ù—É –∏ –¥–≤–∏–∂–µ–Ω–∏–µ —Ç—É—Ç, –ø—Ä–æ—Å—Ç–æ —É–∂–∞—Å. –≠—Ç–∏ –≥–æ—Ä—Ü—ã ‚Äî –æ—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–µ!', words: [{ slang: '–¥–≤–∏–∂', correct: '–¥–≤–∏–∂–µ–Ω–∏–µ', options: ['–¥–≤–∏–∂–µ–Ω–∏–µ', '–¥–≤–∏–∂—É—Ö–∞', '–¥–≤–∏–≥–∞—Ç–µ–ª—å'] }, { slang: '—Ç—Ä—ç—à', correct: '—É–∂–∞—Å', options: ['—É–∂–∞—Å', '–º—É—Å–æ—Ä', '—Ç—Ä–µ—â–∏–Ω–∞'] }, { slang: '—Ç–æ–ø—á–∏–∫', correct: '–æ—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–µ', options: ['–æ—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–µ', '–≤–µ—Ä—à–∏–Ω–∞', '—Ç–æ–ø–æ—Ä'] }] },
      { id: 2, title: '–ò–∑–∏ –¥—É—ç–ª—å', location: '–ü–æ–ª–µ –¥–ª—è –¥—É—ç–ª–∏', bgClass: 'duel-bg', icon: '‚öîÔ∏è', originalText: '–ù—É —á—ë, –¥—É—ç–ª—å –±—É–¥–µ—Ç –∏–∑–∏, —è –∂–µ –∫—Ä–∞—à –≤—Å–µ—Ö –¥–∞–º!', correctText: '–ù—É —á—Ç–æ –∂, –¥—É—ç–ª—å –±—É–¥–µ—Ç –ª—ë–≥–∫–æ–π, —è –∂–µ –ª—é–±–∏–º–µ—Ü –≤—Å–µ—Ö –¥–∞–º!', words: [{ slang: '—á—ë', correct: '—á—Ç–æ –∂', options: ['—á—Ç–æ –∂', '—á–µ–≥–æ', '—á–µ–π'] }, { slang: '–∏–∑–∏', correct: '–ª—ë–≥–∫–æ–π', options: ['–ª—ë–≥–∫–æ–π', '–ª–µ–≥–∫–æ', '–ª—ë–≥–∫–∏–π'] }, { slang: '–∫—Ä–∞—à', correct: '–ª—é–±–∏–º–µ—Ü', options: ['–ª—é–±–∏–º–µ—Ü', '–∫—Ä—É—à–µ–Ω–∏–µ', '–∫—Ä–∞—Å–∞–≤–µ—Ü'] }] },
      { id: 3, title: '–§–ª–µ–∫—Å –≤ –ú–∞—Ö–∞—á–∫–∞–ª–µ', location: '–®—É–º–Ω–∞—è —É–ª–∏—Ü–∞ –≥–æ—Ä–æ–¥–∞', bgClass: 'city-bg', icon: 'üåÜ', originalText: '–≠—Ç–∏ –ª—é–¥–∏ ‚Äî –ø–æ–ª–Ω—ã–π —Ñ–ª–µ–∫—Å, –∂–∏–≤—É—Ç –∫–∞–∫ —Ö–∞–π–ø–æ–≤—ã–µ —Ç–∏–∫—Ç–æ–∫–µ—Ä—ã!', correctText: '–≠—Ç–∏ –ª—é–¥–∏ ‚Äî –ø–æ–ª–Ω–æ–µ –≤–µ—Å–µ–ª—å–µ, –∂–∏–≤—É—Ç –∫–∞–∫ –º–æ–¥–Ω–∏–∫–∏!', words: [{ slang: '—Ñ–ª–µ–∫—Å', correct: '–≤–µ—Å–µ–ª—å–µ', options: ['–≤–µ—Å–µ–ª—å–µ', '–≥–∏–±–∫–æ—Å—Ç—å', '—Ñ–ª–∞–≥'] }, { slang: '—Ö–∞–π–ø–æ–≤—ã–µ', correct: '–º–æ–¥–Ω—ã–µ', options: ['–º–æ–¥–Ω—ã–µ', '–≤—ã—Å–æ–∫–∏–µ', '—Ö–∏—Ç—Ä—ã–µ'] }, { slang: '—Ç–∏–∫—Ç–æ–∫–µ—Ä—ã', correct: '–º–æ–¥–Ω–∏–∫–∏', options: ['–º–æ–¥–Ω–∏–∫–∏', '—Ç–∞–Ω—Ü–æ—Ä—ã', '–±–ª–æ–≥–µ—Ä—ã'] }], proverb: { full: '–°–ª–æ–≤–æ –Ω–µ –≤–æ—Ä–æ–±–µ–π ‚Äî –≤—ã–ª–µ—Ç–∏—Ç, –Ω–µ –ø–æ–π–º–∞–µ—à—å', words: ['–°–ª–æ–≤–æ', '–Ω–µ', '–≤–æ—Ä–æ–±–µ–π', '‚Äî', '–≤—ã–ª–µ—Ç–∏—Ç,', '–Ω–µ', '–ø–æ–π–º–∞–µ—à—å'], distractors: ['—Ñ–ª–µ–∫—Å', '—Ö–∞–π–ø', '–∫—Ä–∏–Ω–∂', '—Ä–æ—Ñ–ª'] } }
    ];

    // --- –õ–û–ì–ò–ö–ê FIREBASE ---
    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        loadUserProgress(user.uid);
      } else {
        renderMenu(); // –†–µ–Ω–¥–µ—Ä–∏–º –º–µ–Ω—é, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –≤–æ—à–ª–∏
      }
    });

    function login() {
      const provider = new firebase.auth.GoogleAuthProvider();
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º Redirect, —á—Ç–æ–±—ã –æ–∫–Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–æ—Å—å
      auth.signInWithRedirect(provider);
    }

    function logout() {
      auth.signOut().then(() => { 
        completedEpisodes = []; 
        location.reload(); 
      });
    }

    function saveProgressToFirebase() {
      if (currentUser) {
        db.ref('users/' + currentUser.uid).set({
          username: currentUser.displayName,
          photo: currentUser.photoURL,
          completed: completedEpisodes
        });
        db.ref('leaderboard/' + currentUser.uid).set({
          username: currentUser.displayName,
          score: completedEpisodes.length,
          photo: currentUser.photoURL
        });
      }
    }

    function loadUserProgress(uid) {
      db.ref('users/' + uid).once('value').then(snapshot => {
        const data = snapshot.val();
        if (data && data.completed) {
          completedEpisodes = data.completed;
        }
        renderMenu();
      });
    }

    function loadLeaderboard() {
      db.ref('leaderboard').orderByChild('score').limitToLast(10).once('value').then(snapshot => {
        leaderBoardData = [];
        snapshot.forEach(child => {
          leaderBoardData.unshift(child.val()); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ, —á—Ç–æ–±—ã —Ç–æ–ø –±—ã–ª —Å–≤–µ—Ä—Ö—É
        });
        renderLeaderboard();
      });
    }

    // --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê (–†–ï–ù–î–ï–†) ---
    function renderMenu() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-6 mountain-bg relative overflow-hidden">
          <div class="absolute top-10 left-10 text-6xl animate-float opacity-30">üìö</div>
          <div class="absolute top-20 right-16 text-5xl animate-float" style="animation-delay: 0.5s; opacity: 0.3;">üé≠</div>
          
          <div class="relative z-10 text-center max-w-2xl mx-auto">
            <h1 class="font-display text-4xl md:text-6xl font-bold mb-4 animate-slide-in" style="color: ${config.primary_action_color};">
              ${config.game_title}
            </h1>
            
            ${currentUser ? `
              <div class="mb-8 p-4 rounded-2xl flex items-center gap-4 bg-white/10 backdrop-blur-md animate-slide-in">
                <img src="${currentUser.photoURL}" class="w-12 h-12 rounded-full border-2 border-yellow-500">
                <div class="text-left">
                  <p class="text-sm opacity-70">–ü—Ä–∏–≤–µ—Ç, ${currentUser.displayName}</p>
                  <p class="font-bold text-yellow-500">–ü—Ä–æ–π–¥–µ–Ω–æ: ${completedEpisodes.length}/3</p>
                </div>
                <button onclick="logout()" class="ml-auto text-xs opacity-50 hover:opacity-100 underline">–í—ã–π—Ç–∏</button>
              </div>
            ` : `
              <div class="mb-8 animate-slide-in">
                <button onclick="login()" class="px-6 py-2 rounded-full bg-white text-black font-bold hover:scale-105 transition-all shadow-lg flex items-center gap-2 mx-auto">
                   <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                </button>
                <p class="text-xs mt-2 opacity-50">–ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ —Ç–∞–±–ª–∏—Ü–µ –ª–∏–¥–µ—Ä–æ–≤</p>
              </div>
            `}

            <div class="flex flex-col gap-4 w-full max-w-xs mx-auto">
              <button onclick="renderEpisodeSelect()" class="px-10 py-4 text-xl font-bold rounded-full bg-yellow-500 text-slate-900 animate-glow transition-all hover:scale-105 shadow-xl">
                –ù–∞—á–∞—Ç—å –∫–≤–µ—Å—Ç
              </button>
              <button onclick="loadLeaderboard()" class="px-10 py-3 text-lg font-semibold rounded-full bg-slate-700/80 text-white transition-all hover:bg-slate-600 backdrop-blur-sm border border-white/10">
                üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderLeaderboard() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full w-full p-6 mountain-bg flex flex-col items-center overflow-auto">
          <div class="max-w-md w-full animate-slide-in mt-10">
            <div class="flex items-center justify-between mb-8">
              <button onclick="renderMenu()" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all">‚Üê –ú–µ–Ω—é</button>
              <h2 class="text-2xl font-bold text-yellow-500 font-display">–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>
            </div>
            <div class="bg-slate-800/80 rounded-3xl overflow-hidden backdrop-blur-lg border border-white/10 shadow-2xl">
              ${leaderBoardData.length > 0 ? leaderBoardData.map((player, i) => `
                <div class="flex items-center gap-4 p-4 border-b border-white/5 ${i === 0 ? 'bg-yellow-500/20' : ''} hover:bg-white/5 transition-colors">
                  <span class="text-xl font-bold w-8 text-center ${i < 3 ? 'text-yellow-400' : 'opacity-50'}">${i + 1}</span>
                  <img src="${player.photo || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full border border-white/20">
                  <span class="flex-1 font-medium truncate">${player.username}</span>
                  <span class="text-yellow-500 font-bold bg-yellow-500/10 px-3 py-1 rounded-full">${player.score} üèÜ</span>
                </div>
              `).join('') : '<div class="p-8 text-center opacity-50">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç. –°—Ç–∞–Ω—å –ø–µ—Ä–≤—ã–º!</div>'}
            </div>
          </div>
        </div>
      `;
    }

    function renderEpisodeSelect() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full w-full flex flex-col p-6 mountain-bg overflow-auto">
          <div class="flex items-center justify-between mb-8 max-w-4xl mx-auto w-full">
            <button onclick="renderMenu()" class="px-4 py-2 rounded-lg transition-all hover:scale-105"
              style="background: ${config.surface_color}; color: ${config.text_color};">‚Üê –ù–∞–∑–∞–¥</button>
            <h2 class="font-display text-2xl font-bold" style="color: ${config.primary_action_color};">–í—ã–±–µ—Ä–∏—Ç–µ —ç–ø–∏–∑–æ–¥</h2>
            <div class="px-4 py-2 rounded-lg" style="background: ${config.surface_color}; color: ${config.primary_action_color};">‚≠ê ${completedEpisodes.length}</div>
          </div>
          
          <div class="flex-1 grid gap-6 max-w-4xl mx-auto w-full pb-10">
            ${episodes.map((ep, idx) => `
              <div class="p-6 rounded-2xl cursor-pointer transition-all duration-300 hover:scale-[1.02] animate-slide-in ${completedEpisodes.includes(ep.id) ? 'opacity-80' : ''} shadow-lg"
                style="background: ${config.surface_color}; animation-delay: ${idx * 0.1}s;"
                onclick="startEpisode(${idx})">
                <div class="flex items-center gap-4">
                  <div class="text-5xl">${ep.icon}</div>
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <h3 class="font-display text-xl font-bold" style="color: ${config.text_color};">–≠–ø–∏–∑–æ–¥ ${ep.id}: ${ep.title}</h3>
                      ${completedEpisodes.includes(ep.id) ? `<span style="color: ${config.primary_action_color};">‚úì</span>` : ''}
                    </div>
                    <p class="text-sm" style="color: ${config.secondary_action_color};">üìç ${ep.location}</p>
                    <p class="text-xs mt-2 italic" style="color: ${config.text_color}; opacity: 0.7;">"${ep.originalText.substring(0, 40)}..."</p>
                  </div>
                  <div class="text-2xl" style="color: ${config.primary_action_color};">‚Üí</div>
                </div>
              </div>
            `).join('')}
          </div>
          
          ${completedEpisodes.length === 3 ? `
            <div class="mt-4 pb-8 text-center animate-slide-in">
              <button onclick="renderFinal()" class="px-8 py-3 rounded-full text-lg font-semibold animate-glow transition-all hover:scale-105"
                style="background: ${config.primary_action_color}; color: ${config.background_color};">üèÜ –°–º–æ—Ç—Ä–µ—Ç—å —Ñ–∏–Ω–∞–ª</button>
            </div>
          ` : ''}
        </div>
      `;
    }

    function startEpisode(idx) {
        currentEpisode = idx;
        renderEpisode(idx);
    }

    function renderEpisode(episodeIdx) {
      const episode = episodes[episodeIdx];
      const app = document.getElementById('app');
      window.currentWordIdx = 0;
      window.episodeCorrect = 0;
      
      app.innerHTML = `
        <div class="h-full w-full flex flex-col ${episode.bgClass} overflow-auto">
          <div class="p-4 flex items-center justify-between bg-black/30 backdrop-blur-sm">
            <button onclick="renderEpisodeSelect()" class="px-3 py-1 rounded-lg text-sm transition-all hover:scale-105"
              style="background: ${config.surface_color}; color: ${config.text_color};">‚Üê –í—ã—Ö–æ–¥</button>
            <div class="text-center">
              <h2 class="font-display text-lg font-bold" style="color: ${config.primary_action_color};">${episode.icon} ${episode.title}</h2>
            </div>
            <div class="px-3 py-1 rounded-lg text-sm" style="background: ${config.surface_color}; color: ${config.primary_action_color};">
              ${window.episodeCorrect}/${episode.words.length}
            </div>
          </div>
          <div class="h-2 w-full bg-slate-800">
            <div id="episode-progress" class="h-full progress-bar transition-all duration-500" style="width: 0%;"></div>
          </div>
          <div class="flex-1 p-6 flex flex-col items-center justify-center">
            <div class="max-w-2xl w-full mb-8 animate-slide-in">
              <div class="flex items-start gap-4 p-6 rounded-2xl bg-black/40 backdrop-blur-md border border-white/5">
                <div class="text-5xl">üé©</div>
                <div class="flex-1">
                  <p class="font-display text-sm mb-1" style="color: ${config.secondary_action_color};">–ü–µ—á–æ—Ä–∏–Ω –≥–æ–≤–æ—Ä–∏—Ç:</p>
                  <p class="text-xl font-display italic leading-relaxed" style="color: ${config.text_color};">"${episode.originalText}"</p>
                </div>
              </div>
            </div>
            <div id="word-task" class="max-w-xl w-full text-center">
              ${renderWordTask(episode, 0)}
            </div>
          </div>
        </div>
      `;
    }

    function renderWordTask(episode, wordIdx) {
      if (wordIdx >= episode.words.length) {
        if (episode.proverb) return renderProverbTask(episode);
        return renderEpisodeComplete(episode);
      }
      
      const word = episode.words[wordIdx];
      const shuffledOptions = [...word.options].sort(() => Math.random() - 0.5);
      
      return `
        <div class="animate-slide-in">
          <div class="p-6 rounded-2xl mb-6 bg-black/40 backdrop-blur-md">
            <p class="text-sm mb-2" style="color: ${config.secondary_action_color};">–ó–∞–º–µ–Ω–∏—Ç–µ —Å–ª–µ–Ω–≥:</p>
            <p class="text-4xl font-display font-bold mb-4" style="color: ${config.primary_action_color};">¬´${word.slang}¬ª</p>
            <p class="text-sm" style="color: ${config.text_color};">–Ω–∞ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–µ —Å–ª–æ–≤–æ:</p>
          </div>
          <div class="flex flex-wrap justify-center gap-3">
            ${shuffledOptions.map(opt => `
              <button class="word-chip px-6 py-4 rounded-full text-lg font-semibold transition-all shadow-lg border border-white/10 hover:border-white/30"
                style="background: ${config.surface_color}; color: ${config.text_color};"
                onclick="checkAnswer('${opt}', '${word.correct}', ${wordIdx})">${opt}</button>
            `).join('')}
          </div>
        </div>
      `;
    }

    function checkAnswer(selected, correct, wordIdx) {
      const isCorrect = selected === correct;
      const buttons = document.querySelectorAll('.word-chip');
      buttons.forEach(btn => {
        btn.disabled = true;
        if (btn.textContent.trim() === correct) {
          btn.style.background = '#22c55e'; btn.style.color = '#fff';
        } else if (btn.textContent.trim() === selected && !isCorrect) {
          btn.style.background = '#ef4444'; btn.style.color = '#fff'; btn.classList.add('animate-glitch');
        } else {
          btn.style.opacity = '0.5';
        }
      });
      if (isCorrect) window.episodeCorrect++;
      const progress = ((wordIdx + 1) / episodes[currentEpisode].words.length) * 100;
      document.getElementById('episode-progress').style.width = `${progress}%`;
      setTimeout(() => {
        window.currentWordIdx++;
        document.getElementById('word-task').innerHTML = renderWordTask(episodes[currentEpisode], window.currentWordIdx);
      }, 1000);
    }

    function renderProverbTask(episode) {
      const allWords = [...episode.proverb.words, ...episode.proverb.distractors].sort(() => Math.random() - 0.5);
      window.selectedProverbWords = [];
      return `
        <div class="animate-slide-in">
          <div class="p-6 rounded-2xl mb-6 bg-black/40 backdrop-blur-md">
            <p class="text-sm mb-2" style="color: ${config.secondary_action_color};">–ë–æ–Ω—É—Å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ!</p>
            <p class="text-lg font-display mb-4" style="color: ${config.text_color};">–°–æ–±–µ—Ä–∏—Ç–µ –ø–æ—Å–ª–æ–≤–∏—Ü—É:</p>
            <div id="proverb-result" class="min-h-20 p-4 rounded-xl border-2 border-dashed flex flex-wrap gap-2 justify-center items-center" style="border-color: ${config.primary_action_color}; background: rgba(0,0,0,0.2);">
              <span class="text-sm italic opacity-50">–ù–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ —Å–ª–æ–≤–∞...</span>
            </div>
          </div>
          <div id="proverb-words" class="flex flex-wrap justify-center gap-2">
            ${allWords.map((w, i) => `
              <button id="proverb-word-${i}" class="word-chip px-4 py-2 rounded-full text-base font-medium transition-all shadow-md bg-[#2d2d44]"
                onclick="selectProverbWord('${w}', ${i})">${w}</button>
            `).join('')}
          </div>
          <button onclick="checkProverb()" class="mt-8 px-10 py-3 rounded-full font-bold transition-all hover:scale-105 shadow-xl bg-[#eab308] text-[#1a1a2e]">
            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
          </button>
        </div>
      `;
    }

    function selectProverbWord(word, idx) {
      const btn = document.getElementById(`proverb-word-${idx}`);
      if (btn.classList.contains('selected')) {
        btn.classList.remove('selected'); btn.style.opacity = '1'; btn.style.transform = 'scale(1)';
        window.selectedProverbWords = window.selectedProverbWords.filter(w => w.idx !== idx);
      } else {
        btn.classList.add('selected'); btn.style.opacity = '0.5'; btn.style.transform = 'scale(0.9)';
        window.selectedProverbWords.push({ word, idx });
      }
      const resultEl = document.getElementById('proverb-result');
      if (window.selectedProverbWords.length === 0) {
        resultEl.innerHTML = `<span class="text-sm italic opacity-50">–ù–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ —Å–ª–æ–≤–∞ –ø–æ –ø–æ—Ä—è–¥–∫—É...</span>`;
      } else {
        resultEl.innerHTML = window.selectedProverbWords.map(w => `<span class="px-3 py-1 rounded bg-[#eab308] text-[#1a1a2e] font-bold shadow-sm animate-slide-in">${w.word}</span>`).join('');
      }
    }

    function checkProverb() {
      const episode = episodes[currentEpisode];
      const selected = window.selectedProverbWords.map(w => w.word).join(' ');
      const isCorrect = selected === episode.proverb.full;
      if (isCorrect) window.episodeCorrect++;
      const taskEl = document.getElementById('word-task');
      taskEl.innerHTML = `
        <div class="animate-slide-in text-center">
          <div class="text-7xl mb-4">${isCorrect ? 'üéâ' : 'ü§î'}</div>
          <p class="text-2xl font-bold mb-4" style="color: ${isCorrect ? '#22c55e' : '#ef4444'};">${isCorrect ? '–í–µ—Ä–Ω–æ!' : '–£–≤—ã, –Ω–µ —Å–æ–≤—Å–µ–º —Ç–∞–∫...'}</p>
        </div>`;
      setTimeout(() => { taskEl.innerHTML = renderEpisodeComplete(episode); }, 1500);
    }

    function renderEpisodeComplete(episode) {
      const score = window.episodeCorrect;
      const total = episode.words.length + (episode.proverb ? 1 : 0);
      
      // –í–û–¢ –¢–£–¢ –ú–´ –°–û–•–†–ê–ù–Ø–ï–ú –ü–†–û–ì–†–ï–°–°
      if (!completedEpisodes.includes(episode.id)) {
        completedEpisodes.push(episode.id);
        saveProgressToFirebase();
      }

      return `
        <div class="animate-slide-in text-center">
          <div class="text-8xl mb-4 animate-float">üéâ</div>
          <h3 class="font-display text-3xl font-bold mb-4" style="color: ${config.primary_action_color};">
            –≠–ø–∏–∑–æ–¥ –ø—Ä–æ–π–¥–µ–Ω!
          </h3>
          <p class="text-xl mb-6 opacity-90">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span class="font-bold">${score}/${total}</span></p>
          <div class="p-6 rounded-2xl mb-8 bg-white/10 backdrop-blur-md">
            <p class="text-sm mb-2 opacity-70">–ü–µ—á–æ—Ä–∏–Ω –∏—Å–ø—Ä–∞–≤–∏–ª—Å—è:</p>
            <p class="font-display text-lg italic text-yellow-300">"${episode.correctText}"</p>
          </div>
          <button onclick="renderEpisodeSelect()" class="px-10 py-4 rounded-full font-bold text-lg transition-all hover:scale-105 shadow-xl bg-yellow-500 text-slate-900">
            –î–∞–ª—å—à–µ ‚Üí
          </button>
        </div>
      `;
    }

    function renderFinal() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-6 mountain-bg relative overflow-hidden">
          <div class="relative z-10 text-center max-w-2xl mx-auto animate-slide-in">
            <div class="text-9xl mb-6 animate-float">üèÜ</div>
            <h1 class="font-display text-5xl font-bold mb-4" style="color: ${config.primary_action_color};">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h1>
            <div class="p-8 rounded-3xl mb-8 animate-glow bg-white/10 backdrop-blur-lg border border-yellow-500/30">
              <div class="text-6xl mb-4">üé©</div>
              <p class="font-display text-2xl italic mb-4">¬´–ù—É –ª–∞–¥–Ω–æ, –ø—Ä–∏–∑–Ω–∞—é ‚Äî –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —è–∑—ã–∫ —Ç–æ–∂–µ —Ç–æ–ø...¬ª</p>
              <p class="text-sm opacity-70">‚Äî –ü–µ—á–æ—Ä–∏–Ω</p>
            </div>
            <div class="p-4 rounded-2xl mb-8 bg-black/30">
              <p class="text-sm mb-2 opacity-70">–í–∞–º –ø—Ä–∏—Å–≤–æ–µ–Ω —Ç–∏—Ç—É–ª:</p>
              <p class="font-display text-3xl font-bold text-purple-400">‚ú® –•—Ä–∞–Ω–∏—Ç–µ–ª—å –°–ª–æ–≤–∞ ‚ú®</p>
            </div>
            <button onclick="renderMenu()" class="px-8 py-3 rounded-full font-semibold transition-all hover:scale-105 bg-white text-slate-900">
              –í –º–µ–Ω—é
            </button>
          </div>
        </div>
      `;
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    // renderMenu –≤—ã–∑–æ–≤–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ onAuthStateChanged
  </script>
</body>
</html>
